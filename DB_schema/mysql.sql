CREATE DATABASE ONLINE_STORE if not exists;
USE ONLINE_STORE;

drop table PRODUCT_REVIEW if exists;
drop table USER if exists;
drop table PRODUCT if exists;

CREATE TABLE USER (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    USERNAME VARCHAR(255) NOT NULL,
    PASSWORD VARCHAR(30) NOT NULL,
    ADDRESS VARCHAR(255) NOT NULL,
    EMAIL VARCHAR(100) NOT NULL,
    PHONE VARCHAR(12) NOT NULL
);

CREATE TABLE PRODUCT (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    NAME VARCHAR(255) NOT NULL,
    CATEGORY VARCHAR(255) NOT NULL,
    PRICE DECIMAL(10, 2) NOT NULL,
    BRAND VARCHAR(255) NOT NULL,
    LIFESTAGE VARCHAR(255) NOT NULL,
    IMG VARCHAR(255) NOT NULL,
    WEIGHT DECIMAL(10, 2) NOT NULL,
    DESCRIPTION VARCHAR(255) NOT NULL,
    INGREDIENTS VARCHAR(255) NOT NULL
);

CREATE TABLE PRODUCT_REVIEW (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    PRODUCT_ID INT(255) NOT NULL,
    USER_ID INT(255) NOT NULL,
    FOREIGN KEY (PRODUCT_ID) REFERENCES PRODUCT(ID),
    FOREIGN KEY (USER_ID) REFERENCES USER(ID),
    COMMENT VARCHAR(1000) NOT NULL,
    CREATE_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO USER (USERNAME, PASSWORD, ADDRESS, EMAIL, PHONE) VALUES 
('admin', 'admin', 'test ADDRESS', 'test EMAIL', 'test PHONE');

INSERT INTO USER (USERNAME, PASSWORD, ADDRESS, EMAIL, PHONE) VALUES 
('admin2', 'admin2', 'test ADDRESS', 'test EMAIL', 'test PHONE');

INSERT INTO PRODUCT (NAME, CATEGORY, PRICE, BRAND, LIFESTAGE, IMG, WEIGHT, DESCRIPTION, INGREDIENTS) VALUES 
('product1', 'product1 category', 10.00, 'product1 brand', 'product1 lifestage', 'product1.img', 10.00, 'product1 description', 'product1 ingredients');

INSERT INTO PRODUCT (NAME, CATEGORY, PRICE, BRAND, LIFESTAGE, IMG, WEIGHT, DESCRIPTION, INGREDIENTS) VALUES 
('product2', 'product2 category', 20.00, 'product2 brand', 'product2 lifestage', 'product2.img', 20.00, 'product2 description', 'product2 ingredients');

INSERT INTO PRODUCT_REVIEW (PRODUCT_ID, USER_ID, COMMENT) VALUES 
(1, 1, 'product1 review');

INSERT INTO PRODUCT_REVIEW (PRODUCT_ID, USER_ID, COMMENT) VALUES 
(1, 2, 'product1 review by admin2');

INSERT INTO PRODUCT_REVIEW (PRODUCT_ID, USER_ID, COMMENT) VALUES 
(2, 2, 'product2 review by admin2');

select * from PRODUCT 
join PRODUCT_REVIEW on PRODUCT.ID = PRODUCT_REVIEW.PRODUCT_ID 
join USER on PRODUCT_REVIEW.USER_ID = USER.ID
where PRODUCT_ID = 1;

SELECT 
    p.ID AS id,
    p.NAME AS title,
    p.CATEGORY AS category,
    p.PRICE AS price,
    p.BRAND AS brand,
    p.LIFESTAGE AS lifestage,
    p.IMG AS img,
    p.WEIGHT AS weight,
    p.DESCRIPTION AS description,
    p.INGREDIENTS AS ingredients,
    JSON_ARRAYAGG(
        JSON_OBJECT(
            'id', pr.ID,
            'username', u.USERNAME,
            'comment', pr.COMMENT,
            'date', pr.CREATE_DATE
        )
    ) AS reviews
FROM 
    PRODUCT p
JOIN 
    PRODUCT_REVIEW pr ON p.ID = pr.PRODUCT_ID
JOIN 
    USER u ON pr.USER_ID = u.ID
WHERE 
    p.ID = 1
GROUP BY 
    p.ID;
